import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import os
from gtts import gTTS
import base64

from utils import (
    init_database, get_cache_timestamp, is_cache_valid, 
    save_to_cache, get_from_cache, fetch_from_api, 
    load_offline_data, get_state_average, format_indian_number,
    get_month_name, get_translations, generate_summary,
    get_all_states_from_cache, get_districts_from_cache,
    get_districts_from_offline, generate_pdf_report
)

st.set_page_config(
    page_title="MGNREGA Dashboard",
    page_icon="ЁЯЗоЁЯЗ│",
    layout="wide",
    initial_sidebar_state="expanded"
)

init_database()

st.markdown("""
<style>
    .main-title {
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    .subtitle {
        font-size: 1.2rem;
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
    }
    .metric-card {
        padding: 1rem;
        border-radius: 0.5rem;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .hindi-label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.2rem;
    }
    .warning-banner {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
        color: #856404;
    }
    .glossary-section {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-top: 2rem;
    }
</style>
""", unsafe_allow_html=True)

trans = get_translations()

with st.sidebar:
    st.header("ЁЯФз Settings / рд╕реЗрдЯрд┐рдВрдЧреНрд╕")
    
    language = st.selectbox(
        "Language / рднрд╛рд╖рд╛",
        options=["English", "рд╣рд┐рдВрджреА"],
        index=0
    )
    lang_code = 'en' if language == "English" else 'hi'
    
    st.markdown("---")
    st.markdown("### ЁЯУЪ Glossary / рд╢рдмреНрджрд╛рд╡рд▓реА")
    
    glossary_label = "ЁЯУЦ Detailed Metric Guide" if lang_code == 'en' else "ЁЯУЦ рд╡рд┐рд╕реНрддреГрдд рдореИрдЯреНрд░рд┐рдХ рдЧрд╛рдЗрдб"
    with st.expander(glossary_label, expanded=False):
        if lang_code == 'en':
            st.markdown("""
            ### ЁЯСитАНЁЯМ╛ Households Worked
            **Definition:** Number of individual households that received employment under MGNREGA during the reporting period.
            
            **Significance:** This metric shows how many families benefited from the scheme. Higher numbers indicate better reach and inclusivity.
            
            **Example:** If 23,450 households worked, it means 23,450 families received wage employment that month.
            
            ---
            
            ### ЁЯТ░ Total Expenditure
            **Definition:** The total amount of money spent on MGNREGA projects in the district, including wages and material costs.
            
            **Significance:** Indicates the scale of economic activity and government investment in rural employment. Higher expenditure typically correlates with more development work.
            
            **Measured In:** Indian Rupees (тВ╣), often displayed in Lakhs (1L = 100,000) or Crores (1Cr = 10,000,000).
            
            **Example:** тВ╣5.8 Crore means the district spent тВ╣58,000,000 on MGNREGA projects.
            
            ---
            
            ### ЁЯз▒ Person-Days Generated
            **Definition:** Total days of employment created. One person working for one day equals one person-day.
            
            **Calculation:** If 100 people work for 10 days each, that's 1,000 person-days.
            
            **Significance:** This is a key indicator of employment generation. The MGNREGA guarantees 100 days of work per household per year, so this metric shows progress toward that goal.
            
            **Example:** 4.2 Lakh person-days = 420,000 days of employment provided to workers.
            
            ---
            
            ### ЁЯТ╡ Average Wage
            **Definition:** The average daily wage paid to MGNREGA workers in the district.
            
            **Significance:** MGNREGA wages must meet or exceed the state's minimum wage. This metric helps track fair compensation.
            
            **Measured In:** Rupees per day (тВ╣/day).
            
            **Example:** тВ╣235.50 per day means on average, each worker earned тВ╣235.50 for a day's work.
            
            ---
            
            ### ЁЯУК Understanding the Dashboard
            - **Green Arrows тЖЧ:** Metric increased from last month (positive trend)
            - **Red Arrows тЖШ:** Metric decreased from last month (needs attention)
            - **District vs State Average:** Shows how your district compares to the state average
            - **6-Month Trend:** Visualizes performance over time to identify patterns
            """)
        else:
            st.markdown("""
            ### ЁЯСитАНЁЯМ╛ рдХреБрд▓ рдкрд░рд┐рд╡рд╛рд░ (Households Worked)
            **рдкрд░рд┐рднрд╛рд╖рд╛:** рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдЕрд╡рдзрд┐ рдХреЗ рджреМрд░рд╛рди рдордирд░реЗрдЧрд╛ рдХреЗ рддрд╣рдд рд░реЛрдЬрдЧрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкрд░рд┐рд╡рд╛рд░реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ред
            
            **рдорд╣рддреНрд╡:** рдпрд╣ рдореИрдЯреНрд░рд┐рдХ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдХрд┐рддрдиреЗ рдкрд░рд┐рд╡рд╛рд░реЛрдВ рдХреЛ рдпреЛрдЬрдирд╛ рд╕реЗ рд▓рд╛рдн рд╣реБрдЖред рдЙрдЪреНрдЪ рд╕рдВрдЦреНрдпрд╛ рдмреЗрд╣рддрд░ рдкрд╣реБрдВрдЪ рдФрд░ рд╕рдорд╛рд╡реЗрд╢рд┐рддрд╛ рдХреЛ рджрд░реНрд╢рд╛рддреА рд╣реИред
            
            **рдЙрджрд╛рд╣рд░рдг:** рдпрджрд┐ 23,450 рдкрд░рд┐рд╡рд╛рд░реЛрдВ рдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛, рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЙрд╕ рдорд╣реАрдиреЗ 23,450 рдкрд░рд┐рд╡рд╛рд░реЛрдВ рдХреЛ рдордЬрджреВрд░реА рд░реЛрдЬрдЧрд╛рд░ рдорд┐рд▓рд╛ред
            
            ---
            
            ### ЁЯТ░ рдХреБрд▓ рд╡реНрдпрдп (Total Expenditure)
            **рдкрд░рд┐рднрд╛рд╖рд╛:** рдЬрд┐рд▓реЗ рдореЗрдВ рдордирд░реЗрдЧрд╛ рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдкрд░ рдЦрд░реНрдЪ рдХреА рдЧрдИ рдХреБрд▓ рд░рд╛рд╢рд┐, рдЬрд┐рд╕рдореЗрдВ рдордЬрджреВрд░реА рдФрд░ рд╕рд╛рдордЧреНрд░реА рдХреА рд▓рд╛рдЧрдд рд╢рд╛рдорд┐рд▓ рд╣реИред
            
            **рдорд╣рддреНрд╡:** рдЧреНрд░рд╛рдореАрдг рд░реЛрдЬрдЧрд╛рд░ рдореЗрдВ рдЖрд░реНрдерд┐рдХ рдЧрддрд┐рд╡рд┐рдзрд┐ рдФрд░ рд╕рд░рдХрд╛рд░реА рдирд┐рд╡реЗрд╢ рдХреЗ рдкреИрдорд╛рдиреЗ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред рдЕрдзрд┐рдХ рд╡реНрдпрдп рдЖрдорддреМрд░ рдкрд░ рдЕрдзрд┐рдХ рд╡рд┐рдХрд╛рд╕ рдХрд╛рд░реНрдп рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реЛрддрд╛ рд╣реИред
            
            **рдорд╛рдк:** рднрд╛рд░рддреАрдп рд░реБрдкрдпреЗ (тВ╣), рдЕрдХреНрд╕рд░ рд▓рд╛рдЦ (1L = 1,00,000) рдпрд╛ рдХрд░реЛрдбрд╝ (1Cr = 1,00,00,000) рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рддред
            
            **рдЙрджрд╛рд╣рд░рдг:** тВ╣5.8 рдХрд░реЛрдбрд╝ рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЬрд┐рд▓реЗ рдиреЗ рдордирд░реЗрдЧрд╛ рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдкрд░ тВ╣5,80,00,000 рдЦрд░реНрдЪ рдХрд┐рдПред
            
            ---
            
            ### ЁЯз▒ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ (Person-Days Generated)
            **рдкрд░рд┐рднрд╛рд╖рд╛:** рд╕реГрдЬрд┐рдд рд░реЛрдЬрдЧрд╛рд░ рдХреЗ рдХреБрд▓ рджрд┐рдиред рдПрдХ рд╡реНрдпрдХреНрддрд┐ рдПрдХ рджрд┐рди рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ = рдПрдХ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ред
            
            **рдЧрдгрдирд╛:** рдпрджрд┐ 100 рд▓реЛрдЧ рдкреНрд░рддреНрдпреЗрдХ 10 рджрд┐рди рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ 1,000 рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ рд╣реИред
            
            **рдорд╣рддреНрд╡:** рдпрд╣ рд░реЛрдЬрдЧрд╛рд░ рд╕реГрдЬрди рдХрд╛ рдПрдХ рдкреНрд░рдореБрдЦ рд╕рдВрдХреЗрддрдХ рд╣реИред рдордирд░реЗрдЧрд╛ рдкреНрд░рддрд┐ рдкрд░рд┐рд╡рд╛рд░ рдкреНрд░рддрд┐ рд╡рд░реНрд╖ 100 рджрд┐рдиреЛрдВ рдХреЗ рдХрд╛рдо рдХреА рдЧрд╛рд░рдВрдЯреА рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдореИрдЯреНрд░рд┐рдХ рдЙрд╕ рд▓рдХреНрд╖реНрдп рдХреА рдУрд░ рдкреНрд░рдЧрддрд┐ рджрд┐рдЦрд╛рддрд╛ рд╣реИред
            
            **рдЙрджрд╛рд╣рд░рдг:** 4.2 рд▓рд╛рдЦ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ = рд╢реНрд░рдорд┐рдХреЛрдВ рдХреЛ 4,20,000 рджрд┐рдиреЛрдВ рдХрд╛ рд░реЛрдЬрдЧрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ред
            
            ---
            
            ### ЁЯТ╡ рдФрд╕рдд рд╡реЗрддрди (Average Wage)
            **рдкрд░рд┐рднрд╛рд╖рд╛:** рдЬрд┐рд▓реЗ рдореЗрдВ рдордирд░реЗрдЧрд╛ рд╢реНрд░рдорд┐рдХреЛрдВ рдХреЛ рджреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдФрд╕рдд рджреИрдирд┐рдХ рдордЬрджреВрд░реАред
            
            **рдорд╣рддреНрд╡:** рдордирд░реЗрдЧрд╛ рдордЬрджреВрд░реА рд░рд╛рдЬреНрдп рдХреА рдиреНрдпреВрдирддрдо рдордЬрджреВрд░реА рдХреЛ рдкреВрд░рд╛ рдпрд╛ рдЙрд╕рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдпрд╣ рдореИрдЯреНрд░рд┐рдХ рдЙрдЪрд┐рдд рдореБрдЖрд╡рдЬреЗ рдХреЛ рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред
            
            **рдорд╛рдк:** рдкреНрд░рддрд┐ рджрд┐рди рд░реБрдкрдпреЗ (тВ╣/рджрд┐рди)ред
            
            **рдЙрджрд╛рд╣рд░рдг:** тВ╣235.50 рдкреНрд░рддрд┐ рджрд┐рди рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдФрд╕рддрди, рдкреНрд░рддреНрдпреЗрдХ рд╢реНрд░рдорд┐рдХ рдиреЗ рдПрдХ рджрд┐рди рдХреЗ рдХрд╛рдо рдХреЗ рд▓рд┐рдП тВ╣235.50 рдХрдорд╛рдПред
            
            ---
            
            ### ЁЯУК рдбреИрд╢рдмреЛрд░реНрдб рдХреЛ рд╕рдордЭрдирд╛
            - **рд╣рд░реЗ рддреАрд░ тЖЧ:** рдкрд┐рдЫрд▓реЗ рдорд╣реАрдиреЗ рд╕реЗ рдореИрдЯреНрд░рд┐рдХ рдореЗрдВ рд╡реГрджреНрдзрд┐ (рд╕рдХрд╛рд░рд╛рддреНрдордХ рд░реБрдЭрд╛рди)
            - **рд▓рд╛рд▓ рддреАрд░ тЖШ:** рдкрд┐рдЫрд▓реЗ рдорд╣реАрдиреЗ рд╕реЗ рдореИрдЯреНрд░рд┐рдХ рдореЗрдВ рдХрдореА (рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреА рдЬрд░реВрд░рдд)
            - **рдЬрд┐рд▓рд╛ рдмрдирд╛рдо рд░рд╛рдЬреНрдп рдФрд╕рдд:** рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХрд╛ рдЬрд┐рд▓рд╛ рд░рд╛рдЬреНрдп рдФрд╕рдд рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХреИрд╕рд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░ рд░рд╣рд╛ рд╣реИ
            - **6 рдорд╣реАрдиреЗ рдХрд╛ рд░реБрдЭрд╛рди:** рд╕рдордп рдХреЗ рд╕рд╛рде рдкреНрд░рджрд░реНрд╢рди рдХреЛ рджреГрд╢реНрдпрдорд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреИрдЯрд░реНрди рдХреА рдкрд╣рдЪрд╛рди рд╣реЛ рд╕рдХреЗ
            """)
    
    st.markdown("---")
    st.markdown("""
    <div style='font-size: 0.8rem; color: #666;'>
    <b>About MGNREGA</b><br>
    The Mahatma Gandhi National Rural Employment Guarantee Act provides at least 100 days of wage employment per year to rural households.
    <br><br>
    <b>рдордирд░реЗрдЧрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ</b><br>
    рдорд╣рд╛рддреНрдорд╛ рдЧрд╛рдВрдзреА рд░рд╛рд╖реНрдЯреНрд░реАрдп рдЧреНрд░рд╛рдореАрдг рд░реЛрдЬрдЧрд╛рд░ рдЧрд╛рд░рдВрдЯреА рдЕрдзрд┐рдирд┐рдпрдо рдЧреНрд░рд╛рдореАрдг рдкрд░рд┐рд╡рд╛рд░реЛрдВ рдХреЛ рдкреНрд░рддрд┐ рд╡рд░реНрд╖ рдХрдо рд╕реЗ рдХрдо 100 рджрд┐рдиреЛрдВ рдХрд╛ рд╡реЗрддрди рд░реЛрдЬрдЧрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
    </div>
    """, unsafe_allow_html=True)

st.markdown(f'<div class="main-title">{trans["title"][lang_code]}</div>', unsafe_allow_html=True)
st.markdown(f'<div class="subtitle">{trans["subtitle"][lang_code]}</div>', unsafe_allow_html=True)

default_states = ["Uttar Pradesh", "Maharashtra", "Karnataka", "Tamil Nadu", "Bihar", "Rajasthan"]
cached_states = get_all_states_from_cache()
available_states = cached_states if cached_states else default_states

col1, col2, col3 = st.columns([2, 2, 1])

with col1:
    selected_state = st.selectbox(
        f"ЁЯЧ║я╕П {trans['select_state'][lang_code]}",
        options=available_states,
        index=0 if "Uttar Pradesh" in available_states else 0
    )

cached_districts = get_districts_from_cache(selected_state)
if not cached_districts:
    cached_districts = get_districts_from_offline(selected_state)
    if not cached_districts:
        cached_districts = ["Lucknow"]

with col2:
    selected_district = st.selectbox(
        f"ЁЯПШя╕П {trans['select_district'][lang_code]}",
        options=cached_districts,
        index=0
    )

with col3:
    st.markdown("<br>", unsafe_allow_html=True)
    fetch_button = st.button(f"ЁЯФН {trans['fetch_data'][lang_code]}", type="primary", width='stretch')

location_help_label = "ЁЯУН Can't find your district? Enter your city/town name:" if lang_code == 'en' else "ЁЯУН рдЕрдкрдирд╛ рдЬрд┐рд▓рд╛ рдирд╣реАрдВ рдорд┐рд▓ рд░рд╣рд╛? рдЕрдкрдиреЗ рд╢рд╣рд░/рдХрд╕реНрдмреЗ рдХрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ:"
with st.expander(location_help_label, expanded=False):
    user_location = st.text_input(
        "City/Town/Village" if lang_code == 'en' else "рд╢рд╣рд░/рдХрд╕реНрдмрд╛/рдЧрд╛рдВрд╡",
        placeholder="e.g., Gomti Nagar, Varanasi Cantt, etc." if lang_code == 'en' else "рдЙрджрд╛рд╣рд░рдг: рдЧреЛрдорддреА рдирдЧрд░, рд╡рд╛рд░рд╛рдгрд╕реА рдЫрд╛рд╡рдиреА, рдЖрджрд┐"
    )
    
    if user_location:
        location_lower = user_location.lower()
        suggested_districts = []
        
        for district in cached_districts:
            if location_lower in district.lower() or district.lower() in location_lower:
                suggested_districts.append(district)
        
        common_mappings = {
            'gomti': 'Lucknow',
            'hazratganj': 'Lucknow',
            'alambagh': 'Lucknow',
            'assi': 'Varanasi',
            'godowlia': 'Varanasi',
            'bhu': 'Varanasi',
            'iit kanpur': 'Kanpur',
            'kanpur central': 'Kanpur',
            'taj mahal': 'Agra',
            'agra fort': 'Agra'
        }
        
        for key, district in common_mappings.items():
            if key in location_lower and district in cached_districts and district not in suggested_districts:
                suggested_districts.append(district)
        
        if suggested_districts:
            st.success(f"{'Suggested district(s):' if lang_code == 'en' else 'рд╕реБрдЭрд╛рдпрд╛ рдЧрдпрд╛ рдЬрд┐рд▓рд╛:'} {', '.join(suggested_districts)}")
            st.info(f"{'Please select from the dropdown above' if lang_code == 'en' else 'рдХреГрдкрдпрд╛ рдКрдкрд░ рдбреНрд░реЙрдкрдбрд╛рдЙрди рд╕реЗ рдЪреБрдиреЗрдВ'}")
        else:
            st.warning(f"{'No matching district found. Please try a different location or select manually.' if lang_code == 'en' else 'рдХреЛрдИ рдореЗрд▓ рдЦрд╛рддрд╛ рдЬрд┐рд▓рд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред рдХреГрдкрдпрд╛ рдПрдХ рдЕрд▓рдЧ рд╕реНрдерд╛рди рдЖрдЬрд╝рдорд╛рдПрдВ рдпрд╛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдЪреБрдиреЗрдВред'}")

@st.cache_data(ttl=86400)
def get_district_data(state, district):
    """Fetch district data with caching and fallback"""
    data_source = "cache"
    timestamp = None
    
    if is_cache_valid(state, district):
        df = get_from_cache(state, district)
        timestamp = get_cache_timestamp(state, district)
        data_source = "cache"
    else:
        api_data = fetch_from_api(state, district)
        
        if api_data:
            df = pd.DataFrame(api_data)
            save_to_cache(state, district, api_data)
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            data_source = "api"
        else:
            df = get_from_cache(state, district)
            
            if df.empty:
                df = load_offline_data(state, district)
                if not df.empty:
                    records = df.to_dict('records')
                    save_to_cache(state, district, records)
                data_source = "offline"
            
            timestamp = get_cache_timestamp(state, district)
    
    return df, data_source, timestamp

if fetch_button or selected_state or selected_district:
    with st.spinner('Loading data... / рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...'):
        df, data_source, last_updated = get_district_data(selected_state, selected_district)
        
        if df.empty:
            st.error("тЪая╕П No data available for this district / рдЗрд╕ рдЬрд┐рд▓реЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ")
            st.stop()
        
        if data_source in ["cache", "offline"]:
            update_date = datetime.strptime(last_updated, '%Y-%m-%d %H:%M:%S').strftime('%d-%m-%Y') if last_updated else "Unknown"
            st.markdown(f"""
            <div class="warning-banner">
                тЪая╕П <b>Showing cached data</b> (last updated on {update_date})<br>
                <i>рдХреИрд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдбреЗрдЯрд╛ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ (рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ: {update_date})</i>
            </div>
            """, unsafe_allow_html=True)
        
        df = df.sort_values(by=['year', 'month'], ascending=False)
        
        latest = df.iloc[0]
        
        st.markdown("---")
        st.subheader(f"ЁЯУК Key Metrics for {selected_district}, {selected_state}")
        st.markdown(f"<i>рдкреНрд░рдореБрдЦ рдореИрдЯреНрд░рд┐рдХреНрд╕: {selected_district}, {selected_state}</i>", unsafe_allow_html=True)
        
        col1, col2, col3, col4 = st.columns(4)
        
        delta_households = None
        delta_expenditure = None
        delta_person_days = None
        delta_wage = None
        
        if len(df) > 1:
            previous = df.iloc[1]
            delta_households = int(latest['households'] - previous['households'])
            delta_expenditure = float(latest['expenditure'] - previous['expenditure'])
            delta_person_days = int(latest['person_days'] - previous['person_days'])
            delta_wage = float(latest['avg_wage'] - previous['avg_wage'])
        
        with col1:
            st.metric(
                label=f"ЁЯСитАНЁЯМ╛ {trans['households'][lang_code]}",
                value=f"{int(latest['households']):,}",
                delta=delta_households
            )
        
        with col2:
            st.metric(
                label=f"ЁЯТ░ {trans['expenditure'][lang_code]}",
                value=format_indian_number(latest['expenditure']),
                delta=delta_expenditure
            )
        
        with col3:
            st.metric(
                label=f"ЁЯз▒ {trans['person_days'][lang_code]}",
                value=format_indian_number(latest['person_days']),
                delta=delta_person_days
            )
        
        with col4:
            st.metric(
                label=f"ЁЯТ╡ {trans['avg_wage'][lang_code]}",
                value=f"тВ╣{latest['avg_wage']:.2f}",
                delta=delta_wage
            )
        
        st.markdown("---")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("ЁЯУИ 6-Month Trend / 6 рдорд╣реАрдиреЗ рдХрд╛ рд░реБрдЭрд╛рди")
            
            trend_df = df.head(6).sort_values(by=['year', 'month'])
            trend_df['month_year'] = trend_df.apply(
                lambda x: f"{get_month_name(x['month'])} {x['year']}", axis=1
            )
            
            fig_line = go.Figure()
            
            fig_line.add_trace(go.Scatter(
                x=trend_df['month_year'],
                y=trend_df['person_days'],
                mode='lines+markers',
                name='Person-Days',
                line=dict(color='#1f77b4', width=3),
                marker=dict(size=8)
            ))
            
            fig_line.update_layout(
                title="Person-Days Generated Over Time",
                xaxis_title="Month",
                yaxis_title="Person-Days",
                hovermode='x unified',
                height=400
            )
            
            st.plotly_chart(fig_line, width='stretch')
        
        with col2:
            st.subheader("ЁЯУК District vs State Average / рдЬрд┐рд▓рд╛ рдмрдирд╛рдо рд░рд╛рдЬреНрдп рдФрд╕рдд")
            
            state_avg = get_state_average(selected_state, latest['year'], latest['month'])
            
            if state_avg:
                comparison_df = pd.DataFrame({
                    'Category': ['District', 'State Avg'],
                    'Person-Days': [latest['person_days'], state_avg['person_days']],
                    'Expenditure': [latest['expenditure'], state_avg['expenditure']]
                })
                
                fig_bar = go.Figure(data=[
                    go.Bar(name='Person-Days', x=comparison_df['Category'], y=comparison_df['Person-Days'], marker_color='#2ca02c'),
                    go.Bar(name='Expenditure (тВ╣)', x=comparison_df['Category'], y=comparison_df['Expenditure'], marker_color='#ff7f0e')
                ])
                
                fig_bar.update_layout(
                    title=f"Comparison for {get_month_name(latest['month'])} {latest['year']}",
                    barmode='group',
                    height=400
                )
                
                st.plotly_chart(fig_bar, width='stretch')
            else:
                st.info("State average data not available / рд░рд╛рдЬреНрдп рдФрд╕рдд рдбреЗрдЯрд╛ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ")
        
        st.markdown("---")
        st.subheader(f"ЁЯУИ {trans['performance_summary'][lang_code]}")
        
        summary_text_en = generate_summary(selected_district, selected_state, df, language='en')
        summary_text_hi = generate_summary(selected_district, selected_state, df, language='hi')
        
        if lang_code == 'en':
            st.markdown(f"{summary_text_en}")
        else:
            st.markdown(f"{summary_text_hi}")
        
        col1, col2, col3 = st.columns([1, 1, 3])
        
        with col1:
            if st.button(f"ЁЯФК {trans['read_summary'][lang_code]}", type="secondary"):
                with st.spinner("Generating audio... / рдСрдбрд┐рдпреЛ рдмрдирд╛ рд░рд╣рд╛ рд╣реИ..."):
                    try:
                        audio_file = "summary_audio.mp3"
                        text_to_speak = summary_text_en if lang_code == 'en' else summary_text_hi
                        
                        tts = gTTS(text=text_to_speak, lang=lang_code, slow=False)
                        tts.save(audio_file)
                        
                        with open(audio_file, "rb") as f:
                            audio_bytes = f.read()
                        
                        st.audio(audio_bytes, format="audio/mp3")
                        
                        if os.path.exists(audio_file):
                            os.remove(audio_file)
                        
                        st.success("тЬЕ Audio ready! / рдСрдбрд┐рдпреЛ рддреИрдпрд╛рд░ рд╣реИ!")
                    except Exception as e:
                        st.error(f"Error generating audio: {str(e)}")
        
        with col2:
            pdf_buffer = generate_pdf_report(selected_district, selected_state, df, language=lang_code)
            if pdf_buffer:
                download_label = "ЁЯУД Download PDF Report" if lang_code == 'en' else "ЁЯУД PDF рд░рд┐рдкреЛрд░реНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ"
                filename = f"MGNREGA_{selected_district}_{datetime.now().strftime('%Y%m%d')}.pdf"
                st.download_button(
                    label=download_label,
                    data=pdf_buffer,
                    file_name=filename,
                    mime="application/pdf",
                    type="primary"
                )
        
        st.markdown("---")
        
        with st.expander("ЁЯУЕ View All Monthly Data / рд╕рднреА рдорд╛рд╕рд┐рдХ рдбреЗрдЯрд╛ рджреЗрдЦреЗрдВ"):
            display_df = df.copy()
            display_df['Month'] = display_df['month'].apply(get_month_name)
            display_df = display_df[['Month', 'year', 'households', 'person_days', 'expenditure', 'avg_wage']]
            display_df.columns = ['Month', 'Year', 'Households', 'Person-Days', 'Expenditure (тВ╣)', 'Avg Wage (тВ╣)']
            st.dataframe(display_df, width='stretch', hide_index=True)
        
        historical_label = "ЁЯУК Historical Trends & Year-over-Year Analysis" if lang_code == 'en' else "ЁЯУК рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд░реБрдЭрд╛рди рдФрд░ рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖ рд╡рд┐рд╢реНрд▓реЗрд╖рдг"
        with st.expander(historical_label, expanded=False):
            all_years = sorted(df['year'].unique(), reverse=True)
            
            if len(all_years) >= 2:
                st.subheader("ЁЯУИ " + ("Year-over-Year Comparison" if lang_code == 'en' else "рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖ рддреБрд▓рдирд╛"))
                
                yoy_data = []
                for month_num in range(5, 11):
                    month_name = get_month_name(month_num)
                    for year in all_years:
                        year_month_data = df[(df['year'] == year) & (df['month'] == month_num)]
                        if not year_month_data.empty:
                            record = year_month_data.iloc[0]
                            yoy_data.append({
                                'Month': month_name,
                                'Year': year,
                                'Person-Days': record['person_days'],
                                'Households': record['households'],
                                'Expenditure': record['expenditure'],
                                'Avg Wage': record['avg_wage']
                            })
                
                if yoy_data:
                    yoy_df = pd.DataFrame(yoy_data)
                    
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        fig_yoy_person_days = go.Figure()
                        for year in all_years:
                            year_data = yoy_df[yoy_df['Year'] == year]
                            fig_yoy_person_days.add_trace(go.Scatter(
                                x=year_data['Month'],
                                y=year_data['Person-Days'],
                                mode='lines+markers',
                                name=str(year),
                                line=dict(width=3),
                                marker=dict(size=8)
                            ))
                        
                        fig_yoy_person_days.update_layout(
                            title="Person-Days: Year-over-Year" if lang_code == 'en' else "рдХрд╛рд░реНрдп рджрд┐рд╡рд╕: рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖",
                            xaxis_title="Month" if lang_code == 'en' else "рдорд╣реАрдирд╛",
                            yaxis_title="Person-Days" if lang_code == 'en' else "рдХрд╛рд░реНрдп рджрд┐рд╡рд╕",
                            hovermode='x unified',
                            height=400
                        )
                        st.plotly_chart(fig_yoy_person_days, width='stretch')
                    
                    with col2:
                        fig_yoy_households = go.Figure()
                        for year in all_years:
                            year_data = yoy_df[yoy_df['Year'] == year]
                            fig_yoy_households.add_trace(go.Scatter(
                                x=year_data['Month'],
                                y=year_data['Households'],
                                mode='lines+markers',
                                name=str(year),
                                line=dict(width=3),
                                marker=dict(size=8)
                            ))
                        
                        fig_yoy_households.update_layout(
                            title="Households: Year-over-Year" if lang_code == 'en' else "рдкрд░рд┐рд╡рд╛рд░: рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖",
                            xaxis_title="Month" if lang_code == 'en' else "рдорд╣реАрдирд╛",
                            yaxis_title="Households" if lang_code == 'en' else "рдкрд░рд┐рд╡рд╛рд░",
                            hovermode='x unified',
                            height=400
                        )
                        st.plotly_chart(fig_yoy_households, width='stretch')
                    
                    st.subheader("ЁЯУЕ " + ("Seasonal Patterns" if lang_code == 'en' else "рдореМрд╕рдореА рдкреИрдЯрд░реНрди"))
                    
                    avg_by_month = yoy_df.groupby('Month').agg({
                        'Person-Days': 'mean',
                        'Households': 'mean',
                        'Expenditure': 'mean',
                        'Avg Wage': 'mean'
                    }).reset_index()
                    
                    months_order = [get_month_name(m) for m in range(5, 11)]
                    avg_by_month['Month'] = pd.Categorical(avg_by_month['Month'], categories=months_order, ordered=True)
                    avg_by_month = avg_by_month.sort_values('Month')
                    
                    col3, col4 = st.columns(2)
                    
                    with col3:
                        fig_seasonal_person_days = go.Figure(data=[
                            go.Bar(
                                x=avg_by_month['Month'],
                                y=avg_by_month['Person-Days'],
                                marker_color='#2ca02c',
                                text=avg_by_month['Person-Days'].apply(lambda x: format_indian_number(x)),
                                textposition='auto'
                            )
                        ])
                        fig_seasonal_person_days.update_layout(
                            title="Average Person-Days by Month" if lang_code == 'en' else "рдорд╣реАрдиреЗ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдФрд╕рдд рдХрд╛рд░реНрдп рджрд┐рд╡рд╕",
                            xaxis_title="Month" if lang_code == 'en' else "рдорд╣реАрдирд╛",
                            yaxis_title="Avg Person-Days" if lang_code == 'en' else "рдФрд╕рдд рдХрд╛рд░реНрдп рджрд┐рд╡рд╕",
                            height=400
                        )
                        st.plotly_chart(fig_seasonal_person_days, width='stretch')
                    
                    with col4:
                        fig_seasonal_expenditure = go.Figure(data=[
                            go.Bar(
                                x=avg_by_month['Month'],
                                y=avg_by_month['Expenditure'],
                                marker_color='#ff7f0e',
                                text=avg_by_month['Expenditure'].apply(lambda x: format_indian_number(x)),
                                textposition='auto'
                            )
                        ])
                        fig_seasonal_expenditure.update_layout(
                            title="Average Expenditure by Month" if lang_code == 'en' else "рдорд╣реАрдиреЗ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдФрд╕рдд рд╡реНрдпрдп",
                            xaxis_title="Month" if lang_code == 'en' else "рдорд╣реАрдирд╛",
                            yaxis_title="Avg Expenditure (тВ╣)" if lang_code == 'en' else "рдФрд╕рдд рд╡реНрдпрдп (тВ╣)",
                            height=400
                        )
                        st.plotly_chart(fig_seasonal_expenditure, width='stretch')
                    
                    latest_year = all_years[0]
                    prev_year = all_years[1]
                    
                    latest_total = yoy_df[yoy_df['Year'] == latest_year]['Person-Days'].sum()
                    prev_total = yoy_df[yoy_df['Year'] == prev_year]['Person-Days'].sum()
                    
                    if prev_total > 0:
                        yoy_change = ((latest_total - prev_total) / prev_total) * 100
                        
                        if lang_code == 'en':
                            summary = f"**Year-over-Year Growth:** In {latest_year}, total person-days were {format_indian_number(latest_total)}, "
                            summary += f"compared to {format_indian_number(prev_total)} in {prev_year}. "
                            if yoy_change > 0:
                                summary += f"This represents a **{yoy_change:.1f}% increase** ЁЯУИ"
                            else:
                                summary += f"This represents a **{abs(yoy_change):.1f}% decrease** ЁЯУЙ"
                        else:
                            summary = f"**рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖ рд╡реГрджреНрдзрд┐:** {latest_year} рдореЗрдВ, рдХреБрд▓ рдХрд╛рд░реНрдп рджрд┐рд╡рд╕ {format_indian_number(latest_total)} рдереЗ, "
                            summary += f"{prev_year} рдореЗрдВ {format_indian_number(prev_total)} рдХреА рддреБрд▓рдирд╛ рдореЗрдВред "
                            if yoy_change > 0:
                                summary += f"рдпрд╣ **{yoy_change:.1f}% рд╡реГрджреНрдзрд┐** рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ ЁЯУИ"
                            else:
                                summary += f"рдпрд╣ **{abs(yoy_change):.1f}% рдХрдореА** рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ ЁЯУЙ"
                        
                        st.markdown(summary)
            else:
                st.info("Multiple years of data required for year-over-year analysis" if lang_code == 'en' else "рд╡рд░реНрд╖-рджрд░-рд╡рд░реНрд╖ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рд▓рд┐рдП рдХрдИ рд╡рд░реНрд╖реЛрдВ рдХрд╛ рдбреЗрдЯрд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ")

st.markdown("---")

comparison_label = "ЁЯФД Compare Multiple Districts" if lang_code == 'en' else "ЁЯФД рдХрдИ рдЬрд┐рд▓реЛрдВ рдХреА рддреБрд▓рдирд╛ рдХрд░реЗрдВ"
with st.expander(comparison_label, expanded=False):
    st.markdown(f"**{'Select districts to compare' if lang_code == 'en' else 'рддреБрд▓рдирд╛ рдХреЗ рд▓рд┐рдП рдЬрд┐рд▓реЗ рдЪреБрдиреЗрдВ'}**")
    
    comparison_districts = st.multiselect(
        "Districts" if lang_code == 'en' else "рдЬрд┐рд▓реЗ",
        options=cached_districts,
        default=[selected_district] if selected_district in cached_districts else []
    )
    
    if len(comparison_districts) >= 2:
        comparison_data = []
        
        for district in comparison_districts:
            district_df, _, _ = get_district_data(selected_state, district)
            if not district_df.empty:
                latest_record = district_df.iloc[0]
                comparison_data.append({
                    'District': district,
                    'Households': int(latest_record['households']),
                    'Person-Days': int(latest_record['person_days']),
                    'Expenditure (тВ╣)': float(latest_record['expenditure']),
                    'Avg Wage (тВ╣)': float(latest_record['avg_wage'])
                })
        
        if comparison_data:
            comp_df = pd.DataFrame(comparison_data)
            
            st.subheader(f"ЁЯУК {'District Comparison' if lang_code == 'en' else 'рдЬрд┐рд▓рд╛ рддреБрд▓рдирд╛'}")
            
            col1, col2 = st.columns(2)
            
            with col1:
                fig_comp_households = go.Figure(data=[
                    go.Bar(
                        x=comp_df['District'],
                        y=comp_df['Households'],
                        marker_color='#1f77b4',
                        text=comp_df['Households'],
                        textposition='auto'
                    )
                ])
                fig_comp_households.update_layout(
                    title="Households Worked" if lang_code == 'en' else "рдХреБрд▓ рдкрд░рд┐рд╡рд╛рд░",
                    xaxis_title="District" if lang_code == 'en' else "рдЬрд┐рд▓рд╛",
                    yaxis_title="Count" if lang_code == 'en' else "рд╕рдВрдЦреНрдпрд╛",
                    height=350
                )
                st.plotly_chart(fig_comp_households, width='stretch')
            
            with col2:
                fig_comp_person_days = go.Figure(data=[
                    go.Bar(
                        x=comp_df['District'],
                        y=comp_df['Person-Days'],
                        marker_color='#2ca02c',
                        text=comp_df['Person-Days'],
                        textposition='auto'
                    )
                ])
                fig_comp_person_days.update_layout(
                    title="Person-Days Generated" if lang_code == 'en' else "рдХрд╛рд░реНрдп рджрд┐рд╡рд╕",
                    xaxis_title="District" if lang_code == 'en' else "рдЬрд┐рд▓рд╛",
                    yaxis_title="Count" if lang_code == 'en' else "рд╕рдВрдЦреНрдпрд╛",
                    height=350
                )
                st.plotly_chart(fig_comp_person_days, width='stretch')
            
            col3, col4 = st.columns(2)
            
            with col3:
                fig_comp_expenditure = go.Figure(data=[
                    go.Bar(
                        x=comp_df['District'],
                        y=comp_df['Expenditure (тВ╣)'],
                        marker_color='#ff7f0e',
                        text=[format_indian_number(x) for x in comp_df['Expenditure (тВ╣)']],
                        textposition='auto'
                    )
                ])
                fig_comp_expenditure.update_layout(
                    title="Total Expenditure" if lang_code == 'en' else "рдХреБрд▓ рд╡реНрдпрдп",
                    xaxis_title="District" if lang_code == 'en' else "рдЬрд┐рд▓рд╛",
                    yaxis_title="Amount (тВ╣)" if lang_code == 'en' else "рд░рд╛рд╢рд┐ (тВ╣)",
                    height=350
                )
                st.plotly_chart(fig_comp_expenditure, width='stretch')
            
            with col4:
                fig_comp_wage = go.Figure(data=[
                    go.Bar(
                        x=comp_df['District'],
                        y=comp_df['Avg Wage (тВ╣)'],
                        marker_color='#d62728',
                        text=[f"тВ╣{x:.2f}" for x in comp_df['Avg Wage (тВ╣)']],
                        textposition='auto'
                    )
                ])
                fig_comp_wage.update_layout(
                    title="Average Wage" if lang_code == 'en' else "рдФрд╕рдд рд╡реЗрддрди",
                    xaxis_title="District" if lang_code == 'en' else "рдЬрд┐рд▓рд╛",
                    yaxis_title="Wage per Day (тВ╣)" if lang_code == 'en' else "рдкреНрд░рддрд┐ рджрд┐рди рд╡реЗрддрди (тВ╣)",
                    height=350
                )
                st.plotly_chart(fig_comp_wage, width='stretch')
            
            st.markdown("### " + ("Comparison Table" if lang_code == 'en' else "рддреБрд▓рдирд╛ рддрд╛рд▓рд┐рдХрд╛"))
            st.dataframe(comp_df, width='stretch', hide_index=True)
    
    elif len(comparison_districts) == 1:
        st.info("Please select at least 2 districts to compare" if lang_code == 'en' else "рддреБрд▓рдирд╛ рдХреЗ рд▓рд┐рдП рдХрдо рд╕реЗ рдХрдо 2 рдЬрд┐рд▓реЗ рдЪреБрдиреЗрдВ")
    else:
        st.info("Select districts from the dropdown above" if lang_code == 'en' else "рдКрдкрд░ рдбреНрд░реЙрдкрдбрд╛рдЙрди рд╕реЗ рдЬрд┐рд▓реЗ рдЪреБрдиреЗрдВ")

st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #666; font-size: 0.9rem;'>
    <p>Data source: Government of India Open Data Portal (data.gov.in)</p>
    <p>рдбреЗрдЯрд╛ рд╕реНрд░реЛрдд: рднрд╛рд░рдд рд╕рд░рдХрд╛рд░ рдУрдкрди рдбреЗрдЯрд╛ рдкреЛрд░реНрдЯрд▓ (data.gov.in)</p>
    <p style='margin-top: 1rem;'>Built with тЭдя╕П for rural India | рдЧреНрд░рд╛рдореАрдг рднрд╛рд░рдд рдХреЗ рд▓рд┐рдП тЭдя╕П рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЧрдпрд╛</p>
</div>
""", unsafe_allow_html=True)
